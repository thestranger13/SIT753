pipeline {
    agent any
    stages {
        // Checkout the code from the Git repository
        stage('Checkout SCM') {
            steps {
                git url: 'https://github.com/thestranger13/SIT753.git', branch: 'main'
            }
        }

        // List files to ensure necessary files are present
        stage('List Files') {
            steps {
                script {
                    sh 'ls -al'
                }
            }
        }

        // Build stage using Docker 
        stage('Build Stage') {
            steps {
                script {
                    // Docker image: release version 1.0.0
                    sh 'docker build -t vehicle-checker:v1.0.0 .'
                }
            }
        }

        // Code Quality Analysis Stage
        stage('Code Quality Analysis Stage') {
            steps {
                script {
                    // Ensure that the dependencies of the project have been installed
                    sh 'npm install'
                    // Run ESLint to check code quality
                    sh 'npm run lint' 
                }
            }
        }

        // Test Web Application
        stage('Test Web Application') {
            steps {
                script {
                    // Run the unit and integration tests using mocha and chai
                    sh 'npm test' 
                }
            }
        }

        // Deploy Docker Container
        stage('Deploy Docker Container') {
            steps {
                script {
                    // Stop and remove any existing container
                    sh 'docker stop vehicle-checker || true'
                    sh 'docker rm vehicle-checker || true'
                    
                    // Run the new Docker container mapped to port 3000
                    sh 'docker run -d --name vehicle-checker -p 3000:3000 vehicle-checker:v1.0.0'
                }
            }
        }
    }
    post {
        always {
            // Clean up old containers if necessary
            sh 'docker rm -f vehicle-checker || true'
        }
    }
}